# Code Review Report

**Date**: 2026-01-17
**Scope**: all
**Reviewed by**: Claude

## Summary

- Total files reviewed: 110 Lean files
- Critical issues: 0
- High priority issues: 3
- Medium priority issues: 5
- Low priority issues: 15+

The ProofChecker codebase demonstrates strong architectural foundations with comprehensive formalization of modal/temporal logic in Lean 4. The project is production-ready for Layer 0 (Bimodal) with well-organized proof systems, semantics, and metalogical results.

## High Priority Issues

### 1. Mixed Deprecated & Active Code in FiniteCanonicalModel.lean
**File**: `Theories/Bimodal/Metalogic/Completeness/FiniteCanonicalModel.lean`
**Description**: File contains both deprecated syntax-based code (with 26+ sorries) AND working semantic approach mixed together
- Deprecated definitions: `IsLocallyConsistent`, `FiniteWorldState`, `finite_truth_lemma` (lines ~758-3365)
- Active infrastructure: `SemanticWorldState`, `semantic_truth_lemma_v2` (lines ~3365+)
- Hard to distinguish which code should be used
**Impact**: Maintainability, confusion about which approach is current
**Recommended fix**: Extract deprecated code to separate module `Completeness/DeprecatedApproach.lean`

**Status**: Already tracked - Related to Task 556 (Complete Metalogic_v2 Implementation)

### 2. Incomplete Metalogic v2 Bridge Lemmas
**File**: `Theories/Bimodal/Metalogic_v2/Representation/ContextProvability.lean:157`
**Description**: `not_derivable_implies_neg_consistent` theorem - bridge lemma to semantic world state not proven
**Impact**: Completeness proof chain has gap requiring axiom
**Recommended fix**: Complete semantic embedding as documented in Task 560 summary

**Status**: Already tracked - Task 566 (Complete Semantic Embedding for Completeness Proof)

### 3. Temporal Logic Causality Gap
**File**: `Theories/Logos/SubTheories/Dynamics/Truth.lean:176`
**Description**: Causal operator semantics incomplete (`sorry` placeholder)
```lean
| Formula.causal φ ψ => -- ○→(φ, ψ): causal operator
  sorry  -- See Task 394 for implementation
```
**Impact**: Dynamics layer cannot reason about causal relationships
**Recommended fix**: Complete implementation per Task 394 specification

**Status**: Already tracked - Task 394/398/399 (Causal Semantics)

## Medium Priority Issues

### 1. Test Coverage Gap for Logos Layer
**Description**: Logos theory files (2,759 LOC) have minimal test coverage compared to Bimodal (33,484 LOC with comprehensive tests)
- 45 test files cover 84 core Lean files (53.6% coverage)
- ~40 Logos theory files have limited or no test coverage
**Impact**: Lower confidence in Logos layer correctness
**Recommended fix**: Create test suite for Logos layer matching Bimodal coverage levels

### 2. Proof Search Documentation Examples Incomplete
**File**: `Theories/Bimodal/Automation/ProofSearch.lean:1347-1358`
**Description**: 3 `sorry` placeholders in documentation examples
**Impact**: Cannot execute example proofs; unclear if aspirational or illustrative
**Recommended fix**: Implement bounded_search algorithm or mark clearly as pseudo-code

### 3. Automation Tactics Stub
**File**: `Theories/Logos/Automation.lean:26`
**Description**: Custom tactic system not implemented (`sorry` with "Would use: modal_k_tactic")
**Impact**: Cannot use `modal_k_tactic` for automated proofs
**Recommended fix**: Implement meta-programming based tactics or defer to documented future phase

### 4. Deprecated Code Infrastructure
**Location**: `Theories/Bimodal/Boneyard/`
**Description**: Contains deprecated approaches (SyntacticApproach.lean, DurationConstruction.lean) with unresolved sorries
**Impact**: Technical debt, potential confusion about current approach
**Recommended fix**: Keep for historical reference but clearly mark as deprecated; consider archiving

### 5. consistent_iff_consistent' Lemma Incomplete
**File**: `Theories/Bimodal/Metalogic_v2/Core/Basic.lean:54-56`
**Description**: Proof depends on ex-falso axiom availability
**Impact**: Consistency definitions not proven equivalent
**Recommended fix**: Add ex-falso axiom to proof system or refactor consistency definitions

**Status**: Already tracked - Task 561 (Cleanup and Documentation)

## Low Priority Issues

### 1. Namespace Duplication
**File**: `Theories/Bimodal/Semantics/TaskFrame.lean:193`
**Message**: `The namespace 'FiniteTaskFrame' is duplicated in the declaration`
**Recommended fix**: Review namespace hierarchy; likely unnecessary nesting

### 2. Unused Section Variables
**File**: `Theories/Bimodal/Semantics/WorldHistory.lean:397,403`
**Description**: `neg_neg_eq` and `neg_injective` theorems have unused section variables
**Recommended fix**: Remove unused variables or use `@[simp]` if intentional

### 3. Unused Simp Arguments (16 instances)
**Locations**: Multiple files
- `TemporalProofStrategies.lean`: Lines 184, 213, 252, 521
- `SoundnessLemmas.lean`: Multiple instances
- `ProofSearch.lean`: Line 324
**Recommended fix**: Remove unused simp arguments or investigate simp set

### 4. Deprecated API Usage
**File**: `Theories/Bimodal/Metalogic/Soundness/SoundnessLemmas.lean:355`
**Description**: `le_of_not_lt` deprecated - should use `le_of_not_gt`
**Recommended fix**: Update to `le_of_not_gt`

### 5. Ineffective Tactics
**File**: `Theories/Bimodal/Automation/ProofSearch.lean:834,935`
**Description**: `'all_goals simp_wf' tactic does nothing`
**Recommended fix**: Remove redundant tactics

### 6. Unused Variables
**File**: `Theories/Bimodal/Automation/ProofSearch.lean:324,886`
**Description**: Unused `ψ` and `hax` variables
**Recommended fix**: Remove unused variables

### 7-15. "Try this" Tactic Suggestions
**Locations**: Multiple files (ContextProvability.lean, RepresentationTheorem.lean, etc.)
**Description**: Lean suggests simplified proof syntax
**Recommended fix**: Apply suggestions in systematic cleanup pass

## Code Quality Metrics

| Metric | Value | Status |
|--------|-------|--------|
| Sorry count (Logos) | 7 | Warning |
| Sorry count (Bimodal) | 198 | Critical (mostly deprecated/examples) |
| Axioms in active code | 14 | OK (all validated) |
| Axioms in deprecated code | 1 | Warning (unused) |
| Build status | Pass | OK |
| Test coverage | 53.6% | Warning |
| Compiler warnings | 30+ | Warning (mostly trivial) |

## Recommendations

1. **Complete Task 566 (Semantic Embedding)** - Resolves the remaining axiom in completeness proof
2. **Complete Task 561 (Cleanup)** - Resolves consistent_iff_consistent and related sorries
3. **Separate deprecated code** - Extract deprecated syntactic approach from FiniteCanonicalModel.lean
4. **Systematic warning cleanup** - Address compiler warnings in a dedicated pass
5. **Expand Logos test coverage** - Match Bimodal layer's comprehensive testing

## Tasks Created

Based on this review with `--create-tasks`:

**Existing tasks that address high-priority issues**:
- Task 566: Complete Semantic Embedding (addresses bridge lemma gap)
- Task 561: Cleanup and Documentation (addresses consistent_iff_consistent)
- Task 394/398/399: Causal Semantics (addresses causality `sorry`)
- Task 556: Complete Metalogic_v2 (parent task for cleanup)

**New tasks created from this review**:
- Task 567: Separate Deprecated Code from FiniteCanonicalModel (Medium priority)
- Task 568: Expand Logos Test Coverage (Medium priority)
