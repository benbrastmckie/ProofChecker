# Code Review Report

**Date**: 2026-01-31
**Scope**: all (full codebase with roadmap integration)
**Session**: sess_1769819176_7c46cb
**Reviewed by**: Claude

## Summary

- Total Lean files reviewed: 171
- Build status: **Passing** (707 jobs completed)
- Critical issues: 0
- High priority issues: 2
- Medium priority issues: 3
- Low priority issues: 5

## Code Quality Metrics

| Metric | Value | Status |
|--------|-------|--------|
| Sorry count | 196 | Manageable |
| Axiom count | 703 | Info |
| Build errors | 0 | OK |
| Build warnings | 30 | Info |
| TODO comments | 17 | Info |
| FIXME comments | 0 | OK |
| Build status | Pass | OK |

**Note on axioms**: The 703 "axiom" matches include axiom schemas in the proof system (e.g., `axiom_K`, `axiom_T`) which are intentional proof system components, not incomplete proofs.

## High Priority Issues

### H1. Build Warnings - Deprecated API Usage

**Files**:
- `Theories/Bimodal/Theorems/Propositional.lean:402,596`

**Description**: Two references to deprecated `efq` theorem that should use `efq_neg` instead.

**Impact**: Code rot, will break in future Lean versions.

**Recommended fix**: Replace `efq` with `efq_neg` in both locations.

---

### H2. Unused Simp Arguments in DeductionTheorem

**Files**:
- `Theories/Bimodal/Metalogic/Core/DeductionTheorem.lean:106,134,143,228,271,278`

**Description**: Six unused simp arguments (`List.filter`) generating linter warnings. Also two `simp_wf` tactics that do nothing (lines 300, 442).

**Impact**: Build noise, potential performance overhead from unnecessary simp processing.

**Recommended fix**: Remove unused arguments from simp calls, remove or replace ineffective `simp_wf` tactics.

---

## Medium Priority Issues

### M1. Duplicated Namespace Declaration

**File**: `Theories/Bimodal/Semantics/TaskFrame.lean:193`

**Description**: Namespace 'FiniteTaskFrame' is duplicated in declaration `Bimodal.Semantics.FiniteTaskFrame.FiniteTaskFrame.toTaskFrame`.

**Impact**: Confusing namespace hierarchy, potential naming collisions.

**Recommended fix**: Restructure declaration to avoid nested duplicate namespace.

---

### M2. Unused Section Variables

**Files**:
- `Theories/Bimodal/Semantics/WorldHistory.lean:397,403`

**Description**: Theorems `neg_neg_eq` and `neg_injective` have automatically included section variables that are unused.

**Impact**: Unnecessary type parameter bloat.

**Recommended fix**: Move theorems outside section or use explicit parameters.

---

### M3. Sorries in Example Files

**Files**:
- `Theories/Bimodal/Examples/ModalProofs.lean` (5 sorries)
- `Theories/Bimodal/Examples/ModalProofStrategies.lean` (5 sorries)
- `Theories/Bimodal/Examples/TemporalProofs.lean` (2 sorries)
- `Theories/Bimodal/Automation/ProofSearch.lean` (3 sorries)

**Description**: 15 sorries in example and automation files representing incomplete proofs or exercises.

**Impact**: Examples with incomplete proofs reduce educational value. Automation sorries limit proof search capability.

**Recommended fix**: Complete proofs or document as intentional exercises.

---

## Low Priority Issues

### L1. Task State Inconsistency - Task 398 Status

**File**: `specs/TODO.md` vs `specs/state.json`

**Description**: Task 398 shows `[IMPLEMENTING]` in TODO.md but `"planned"` in state.json.

**Impact**: Minor state desync could cause workflow issues.

**Recommended fix**: Run `/task --sync` to reconcile.

---

### L2. Active Meta Tasks Stalled

**Tasks**: 672, 674, 619

**Description**: Three meta tasks in various research/planned states with no recent activity:
- Task 672: Agent system upgrade plan (revised 2026-01-22)
- Task 674: Command-skill-agent architecture (planned, no recent update)
- Task 619: Context:fork migration (blocked by GitHub #16803)

**Impact**: Task list accumulation without resolution.

**Recommended fix**: Review and either advance, defer, or abandon these tasks.

---

### L3. Representation Directory Sorry Concentration

**Files**: `Theories/Bimodal/Metalogic/Representation/*.lean`

**Description**: ~30 sorries concentrated in Representation/ subdirectory:
- `CoherentConstruction.lean`: ~10 sorries (cross-origin coherence)
- `TaskRelation.lean`: 5 sorries (compositionality)
- `UniversalCanonicalModel.lean`: 5 sorries (consistency proofs)
- `IndexedMCSFamily.lean`: 4 sorries (family construction)
- `CanonicalWorld.lean`: 2 sorries (MCS properties)
- `TemporalCompleteness.lean`: 2 sorries (H/G-completeness)

**Impact**: Documented in ROAD_MAP.md as non-blocking (representation_theorem is sorry-free). Low priority since `semantic_weak_completeness` provides sorry-free completeness path.

**Recommended fix**: Address opportunistically; critical path is clear.

---

### L4. stale worktree CLAUDE.md references

**File**: `/home/benjamin/Projects/ProofChecker/CLAUDE.md`

**Description**: Root CLAUDE.md contains worktree task metadata for "agent_system" and "subagents" worktrees that may be stale or from other branches.

**Impact**: Confusing context for new sessions.

**Recommended fix**: Review and clean up worktree metadata in CLAUDE.md or isolate to worktree-specific files.

---

### L5. Missing Plan File Reference

**File**: `specs/TODO.md:127`

**Description**: Task 672 references `implementation-003.md` but state.json shows `implementation-002.md`.

**Impact**: Plan file reference mismatch.

**Recommended fix**: Verify correct plan version and sync references.

---

## Roadmap Progress

### Current Roadmap Status

| Section | Total Items | Completed | Progress |
|---------|-------------|-----------|----------|
| Phase 0: Complete Core Proofs | 12 | 7 | 58% |
| Phase 1: Proof Quality | 16 | 4 | 25% |
| Phase 2: Generalization | 14 | 3 | 21% |
| Phase 3: Extensions | 27 | 0 | 0% |
| Phase 4: Architecture | 8 | 4 | 50% |
| Phase 5: Managing Sorries | 0 | 0 | N/A |
| Phase 6: Polish & Publication | 6 | 4 | 67% |

### Completed Since Last Review

No new roadmap items completed since review-20260129-2.

### Current Focus

**Phase 0 (High Priority)**: Complete Core Proofs
- First incomplete: "Review `Boneyard/Metalogic_v2/Core/` for reusable elements"
- Items remaining: 5

**Phase 1 (High Priority)**: Proof Quality and Organization
- First incomplete: "Audit proof dependencies"
- Items remaining: 12

### Annotations Suggested

None - no completed tasks found that match incomplete roadmap items.

### Recommended Next Tasks

Based on roadmap priorities and current state:

1. **Boneyard port evaluation** (Phase 0.2, High)
   - Evaluate DeductionTheorem.lean and MaximalConsistent.lean compatibility
   - Language: lean

2. **Proof economy audit** (Phase 1.1, High)
   - Map proof dependencies, identify redundant paths
   - Language: lean

3. **Utilities refactoring** (Phase 1.2, High)
   - Extract common patterns into Metalogic.Util module
   - Language: lean

4. **Proof architecture guide** (Phase 1.3, Medium)
   - Create docs/architecture/proof-structure.md
   - Language: meta

5. **Craig Interpolation** (Phase 3.1.A, Medium)
   - Define propositional variables, implement extraction
   - Language: lean

## Active Tasks Summary

| Task | Status | Priority | Language | Description |
|------|--------|----------|----------|-------------|
| 394 | RESEARCHED | High | lean | Causal semantics port |
| 398 | IMPLEMENTING | High | markdown | Port to recursive-semantics.md |
| 399 | PLANNED | High | lean | Implement in Lean |
| 778 | PLANNED | Medium | meta | Remove priority system |
| 777 | RESEARCHED | Medium | lean | weak_completeness sorry |
| 685 | RESEARCHED | Medium | lean | World-history/Barcan theorems |
| 672 | REVISED | High | meta | Agent system upgrade |
| 674 | IMPLEMENTING | High | meta | Command-skill architecture |
| 619 | RESEARCHED | Medium | meta | Context:fork migration |

## Recommendations

1. **Quick Wins**: Fix the two deprecated `efq` references and remove unused simp arguments in DeductionTheorem.lean - straightforward fixes that eliminate 8+ build warnings.

2. **Task Hygiene**: Run `/task --sync` to reconcile Task 398 state desync, then evaluate stalled meta tasks (672, 674, 619) for advancement or abandonment.

3. **Focus Direction**: Current priority should be Phase 0 (Boneyard port) and Phase 1 (proof quality) as documented in ROAD_MAP.md's "Near Term" section.

4. **Sorry Management**: The 196 sorries are well-documented and non-blocking. The critical path (`representation_theorem`, `semantic_weak_completeness`, `compactness`) is sorry-free.
