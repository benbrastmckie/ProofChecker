# .opencode/ to .claude/ Migration Plan

## Executive Summary

This plan describes how to reproduce the functionality of the `.opencode/` agent system using Claude Code's native `.claude/` configuration system. The goal is to achieve equivalent workflow UX and robust functionality while leveraging Claude Code's native capabilities.

---

## Architecture Comparison

### .opencode/ Architecture (Current)
```
3-Layer Delegation:
  Orchestrator (router) → Commands (argument parsing) → Subagents (execution)

Key Components:
  - 9 slash commands (task, research, plan, implement, revise, review, todo, errors, meta)
  - 15+ subagents (researcher, planner, implementer, lean-*, status-sync-manager, etc.)
  - Context system (core/ + project/ with lazy loading)
  - State management (TODO.md + state.json + errors.json)
  - Safety mechanisms (session IDs, cycle detection, depth limits, timeouts)
  - Atomic status updates (two-phase commit pattern)
  - Automatic git commits
```

### .claude/ Architecture (Target)
```
Claude Code Native:
  CLAUDE.md (memory) + commands/ (slash commands) + skills/ (auto-invoked agents)

Key Capabilities:
  - Slash commands with $ARGUMENTS, model selection, tool restrictions
  - Agent Skills with automatic discovery and subagent isolation
  - Hooks for lifecycle events (PreToolUse, PostToolUse, SessionStart, etc.)
  - Hierarchical CLAUDE.md with @imports and rules/*.md modules
  - settings.json for team configuration
```

---

## Feature Mapping Table

| .opencode/ Feature | .claude/ Equivalent | Notes |
|--------------------|---------------------|-------|
| `agent/orchestrator.md` | `CLAUDE.md` + orchestration skill | Core routing logic in memory |
| `command/*.md` | `commands/*.md` | Direct mapping with frontmatter changes |
| `agent/subagents/*.md` | `skills/` directories | Each subagent becomes a skill |
| `context/core/*` | `rules/*.md` + CLAUDE.md | Modular rules with path matching |
| `context/project/*` | `CLAUDE.md` @imports | Project-specific via imports |
| `specs/TODO.md` | Same location | State tracking unchanged |
| `specs/state.json` | Same location | Machine state unchanged |
| `specs/errors.json` | Same location | Error tracking unchanged |
| Two-phase commit | PostToolUse hooks | Atomic updates via hooks |
| Git auto-commits | PostToolUse hooks | Commit after command completion |
| Session ID tracking | Skill context + hooks | Native subagent isolation |
| Timeout enforcement | Skill configuration | Via model + context settings |

---

## Phase 1: Foundation Setup (Day 1)

### 1.1 Create Directory Structure

```
.claude/
├── settings.json              # Team configuration
├── settings.local.json        # Personal overrides (gitignored)
├── CLAUDE.md                  # Project memory (orchestration core)
├── rules/                     # Modular instruction sets
│   ├── lean4.md              # Lean-specific rules (paths: **/*.lean)
│   ├── state-management.md   # TODO.md/state.json patterns
│   ├── git-workflow.md       # Commit conventions
│   └── error-handling.md     # Error tracking patterns
├── commands/                  # Slash commands (9 total)
│   ├── task.md
│   ├── research.md
│   ├── plan.md
│   ├── implement.md
│   ├── revise.md
│   ├── review.md
│   ├── todo.md
│   ├── errors.md
│   └── meta.md
└── skills/                    # Agent skills (auto-discovered)
    ├── orchestrator/          # Core routing skill
    │   └── SKILL.md
    ├── researcher/            # Research execution
    │   └── SKILL.md
    ├── planner/               # Plan creation
    │   └── SKILL.md
    ├── implementer/           # Implementation execution
    │   └── SKILL.md
    ├── lean-research/         # Lean-specific research
    │   └── SKILL.md
    ├── lean-implementation/   # Lean-specific implementation
    │   └── SKILL.md
    ├── status-sync/           # Atomic status updates
    │   └── SKILL.md
    ├── git-workflow/          # Git commit management
    │   └── SKILL.md
    └── task-management/       # Task creation/division
        └── SKILL.md
```

### 1.2 Create settings.json

```json
{
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Read",
      "Write",
      "Edit",
      "Glob",
      "Grep",
      "WebSearch",
      "WebFetch",
      "Task",
      "TodoWrite"
    ],
    "deny": [
      "Bash(rm -rf /)",
      "Bash(sudo *)"
    ]
  },
  "hooks": {
    "SessionStart": [{
      "matcher": "startup",
      "hooks": [{
        "type": "command",
        "command": "echo 'ProofChecker session started' >> /tmp/claude-sessions.log"
      }]
    }],
    "PostToolUse": [{
      "matcher": "Write",
      "hooks": [{
        "type": "command",
        "command": "bash .claude/hooks/post-write.sh"
      }]
    }]
  }
}
```

### 1.3 Create CLAUDE.md (Core Memory)

```markdown
# ProofChecker Development System

This project uses a structured task management and agent orchestration system.

## Quick Reference
- @.claude/rules/state-management.md - Task states and transitions
- @.claude/rules/git-workflow.md - Commit conventions
- @.opencode/specs/TODO.md - Active task list
- @.opencode/specs/state.json - Machine state

## Orchestration Pattern

When receiving a command like `/task`, `/research`, `/plan`, `/implement`:

1. **Parse Arguments**: Extract task number and optional prompt from $ARGUMENTS
2. **Validate**: Check task exists in TODO.md/state.json
3. **Route by Language**:
   - lean → Use Lean-specific skills (lean-research, lean-implementation)
   - general → Use general skills (researcher, implementer)
4. **Execute**: Invoke appropriate skill with context
5. **Update State**: Sync TODO.md and state.json atomically
6. **Commit**: Create scoped git commit if changes made

## Key Patterns

### Status Markers
- [NOT STARTED] → [RESEARCHED] → [PLANNED] → [COMPLETED]
- Intermediate: [RESEARCHING], [PLANNING], [IMPLEMENTING]
- Terminal: [BLOCKED], [ABANDONED], [PARTIAL]

### Task Number Format
Tasks are numbered sequentially: 1, 2, 3, ..., 346
Stored in state.json.next_project_number

### Artifact Paths
- Research: .opencode/specs/{NUMBER}_{SLUG}/reports/research-{NNN}.md
- Plans: .opencode/specs/{NUMBER}_{SLUG}/plans/implementation-{NNN}.md
- Summaries: .opencode/specs/{NUMBER}_{SLUG}/summaries/

## Project Context
- Lean 4 theorem prover with Mathlib
- Modal and temporal logic formalization
- MCP integration via lean-lsp server
```

---

## Phase 2: Command Migration (Days 2-3)

### 2.1 Command Template

Each command file follows this structure:

```markdown
---
description: Brief description for /help listing
allowed-tools: Read, Write, Edit, Glob, Grep, Task, TodoWrite
argument-hint: TASK_NUMBER [PROMPT]
model: claude-opus-4-5-20251101
---

# Command: /name

## Arguments
- `$1` - Task number (required)
- `$2` - Optional prompt/focus

## Execution

[Command-specific instructions that invoke skills and manage state]
```

### 2.2 Command: /task

**File**: `.claude/commands/task.md`

```markdown
---
description: Create, recover, divide, sync, or abandon tasks
allowed-tools: Read, Write, Edit, Glob, Grep, Task, TodoWrite
argument-hint: "description" | --recover N | --divide N | --sync | --abandon N
model: claude-opus-4-5-20251101
---

# /task Command

Parse $ARGUMENTS to determine mode:
- If starts with `--recover`: Recover tasks from archive
- If starts with `--divide`: Divide task into subtasks
- If starts with `--sync`: Sync TODO.md with state.json
- If starts with `--abandon`: Archive tasks
- Otherwise: Create new task with description

## Create Task Mode

1. Read @.opencode/specs/state.json for next_project_number
2. Extract description from: $ARGUMENTS
3. Detect language from keywords (lean, theorem, proof → lean; else → general)
4. Create slug from description (lowercase, underscores, max 50 chars)
5. Create task directory: .opencode/specs/{NUMBER}_{SLUG}/
6. Update TODO.md with new entry (Status: [NOT STARTED])
7. Update state.json (increment next_project_number, add to active_projects)
8. Git commit: "task {N}: create {title}"

## Output Format
Task #{NUMBER} created: {TITLE}
Status: [NOT STARTED]
Language: {lean|general}
Path: .opencode/specs/{NUMBER}_{SLUG}/
```

### 2.3 Command: /research

**File**: `.claude/commands/research.md`

```markdown
---
description: Research a task and create reports
allowed-tools: Read, Write, Edit, Glob, Grep, WebSearch, WebFetch, Task, TodoWrite
argument-hint: TASK_NUMBER [FOCUS]
model: claude-opus-4-5-20251101
---

# /research Command

## Arguments
- `$1` - Task number (required)
- `$2...` - Optional focus prompt

## Execution

1. **Validate**: Read @.opencode/specs/state.json, verify task $1 exists
2. **Load Task**: Get description, language from TODO.md entry
3. **Update Status**: Set to [RESEARCHING] in TODO.md and state.json
4. **Route by Language**:
   - If language == "lean": Use lean-lsp tools (lean_leansearch, lean_loogle, lean_leanfinder)
   - Else: Use WebSearch, WebFetch, Read tools
5. **Research**:
   - Search for relevant documentation, patterns, approaches
   - Analyze existing codebase for related code
   - Gather implementation examples
6. **Create Report**: Write to .opencode/specs/{N}_{SLUG}/reports/research-001.md
7. **Update Status**: Set to [RESEARCHED]
8. **Git Commit**: "task {N}: complete research"

## Report Template
```
# Research Report: Task #{N}

## Summary
[2-3 sentence overview]

## Findings
### [Topic 1]
[Details]

### [Topic 2]
[Details]

## Recommendations
1. [Approach recommendation]
2. [Key considerations]

## References
- [Source 1]
- [Source 2]
```
```

### 2.4 Command: /plan

**File**: `.claude/commands/plan.md`

```markdown
---
description: Create implementation plan for a task
allowed-tools: Read, Write, Edit, Glob, Grep, Task, TodoWrite
argument-hint: TASK_NUMBER
model: claude-opus-4-5-20251101
---

# /plan Command

## Arguments
- `$1` - Task number (required)

## Execution

1. **Validate**: Verify task exists and status is [RESEARCHED] or [NOT STARTED]
2. **Load Context**:
   - Task description from TODO.md
   - Research reports from .opencode/specs/{N}_{SLUG}/reports/
   - Relevant codebase context
3. **Update Status**: Set to [PLANNING]
4. **Create Plan**:
   - Break into phases (1-5 phases, each 1-2 hours)
   - Identify files to modify/create
   - List dependencies and risks
5. **Write Plan**: .opencode/specs/{N}_{SLUG}/plans/implementation-001.md
6. **Update Status**: Set to [PLANNED]
7. **Git Commit**: "task {N}: create implementation plan"

## Plan Template
```
# Implementation Plan: Task #{N}

## Overview
[Summary of approach]

## Phases

### Phase 1: [Name]
**Estimated effort**: X hours
**Status**: [NOT STARTED]

**Objectives**:
1. [Objective]

**Files to modify**:
- path/to/file.ext

**Steps**:
1. [Step]

### Phase 2: [Name]
...

## Risks and Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| [Risk] | [Impact] | [Mitigation] |

## Success Criteria
- [ ] [Criterion]
```
```

### 2.5 Command: /implement

**File**: `.claude/commands/implement.md`

```markdown
---
description: Execute implementation for a task
allowed-tools: Read, Write, Edit, Glob, Grep, Bash, Task, TodoWrite, mcp__lean-lsp__*
argument-hint: TASK_NUMBER
model: claude-opus-4-5-20251101
---

# /implement Command

## Arguments
- `$1` - Task number (required)

## Execution

1. **Validate**: Verify task exists and status is [PLANNED] or [IMPLEMENTING]
2. **Load Plan**: Read .opencode/specs/{N}_{SLUG}/plans/implementation-{latest}.md
3. **Detect Resume Point**: Find first phase with status [NOT STARTED] or [IN PROGRESS]
4. **Update Status**: Set to [IMPLEMENTING] in TODO.md/state.json
5. **Execute Phases**:
   - For each phase starting from resume point:
     - Update phase status to [IN PROGRESS]
     - Execute steps in phase
     - If language == "lean": Use lean-lsp tools for compilation/verification
     - Update phase status to [COMPLETED]
     - Git commit: "task {N} phase {P}: {phase_name}"
6. **Final Status**: Set to [COMPLETED] when all phases done
7. **Create Summary**: .opencode/specs/{N}_{SLUG}/summaries/implementation-summary-{DATE}.md
8. **Git Commit**: "task {N}: complete implementation"

## Error Handling
- On error: Keep status as [IMPLEMENTING], log error
- On timeout: Mark current phase [PARTIAL], preserve progress
- Resume next run from last incomplete phase
```

### 2.6 Commands: /revise, /review, /todo, /errors, /meta

Follow similar patterns - each command:
1. Parses $ARGUMENTS
2. Validates input
3. Updates status at start
4. Performs core operation
5. Updates status at end
6. Creates git commit

---

## Phase 3: Skill Migration (Days 4-6)

### 3.1 Skill Template

```markdown
---
name: skill-name
description: When to invoke this skill (used for automatic discovery)
allowed-tools: [tools list]
context: fork
---

# Skill: name

## Trigger Conditions
This skill activates when:
- [Condition 1]
- [Condition 2]

## Inputs Expected
- task_number: integer
- context: object with description, language, artifacts

## Execution Steps
1. [Step]
2. [Step]

## Return Format
Always return JSON:
```json
{
  "status": "completed|partial|failed|blocked",
  "summary": "Brief summary",
  "artifacts": [{"path": "...", "type": "...", "description": "..."}],
  "errors": []
}
```
```

### 3.2 Core Skills

| Skill | Directory | Purpose |
|-------|-----------|---------|
| `orchestrator` | `.claude/skills/orchestrator/` | Route commands to appropriate skills |
| `researcher` | `.claude/skills/researcher/` | General research execution |
| `planner` | `.claude/skills/planner/` | Create implementation plans |
| `implementer` | `.claude/skills/implementer/` | Execute implementations |
| `lean-research` | `.claude/skills/lean-research/` | Lean-specific research (LeanSearch, Loogle) |
| `lean-implementation` | `.claude/skills/lean-implementation/` | Lean proof implementation |
| `status-sync` | `.claude/skills/status-sync/` | Atomic TODO.md/state.json updates |
| `git-workflow` | `.claude/skills/git-workflow/` | Scoped git commits |
| `task-management` | `.claude/skills/task-management/` | Task CRUD operations |

### 3.3 Example Skill: status-sync

**File**: `.claude/skills/status-sync/SKILL.md`

```markdown
---
name: status-sync
description: Atomically update task status across TODO.md and state.json. Use when task status changes.
allowed-tools: Read, Write, Edit
context: fork
---

# Status Sync Skill

## Trigger Conditions
Invoke when:
- Task status needs to change (e.g., NOT STARTED → RESEARCHING)
- Task artifacts are added (research reports, plans)
- Task completion/failure

## Inputs
- task_number: integer
- new_status: string (e.g., "researched", "planned", "completed")
- artifacts: optional array of {path, type, description}

## Two-Phase Commit Pattern

### Phase 1: Prepare
1. Read current TODO.md
2. Read current state.json
3. Validate task exists in both
4. Prepare updated versions in memory

### Phase 2: Commit
1. Write updated state.json (machine state first)
2. Write updated TODO.md (user-facing second)
3. If either fails, attempt rollback

### Rollback
If write fails:
1. Re-read original files
2. Restore from backup
3. Report failure

## Return Format
```json
{
  "status": "completed",
  "summary": "Updated task #N status to [STATUS]",
  "artifacts": [],
  "errors": []
}
```
```

---

## Phase 4: Context Migration (Day 7)

### 4.1 Rules Migration

Convert `.opencode/context/core/*` to `.claude/rules/*.md`:

| Source | Target | Paths Matcher |
|--------|--------|---------------|
| `core/standards/code-standards.md` | `rules/code-standards.md` | `**/*.{ts,js,lean}` |
| `core/standards/git-conventions.md` | `rules/git-workflow.md` | - |
| `core/workflows/status-transitions.md` | `rules/state-management.md` | `.opencode/specs/**` |
| `lean4/*` | `rules/lean4.md` | `**/*.lean` |

### 4.2 Rules Format

```markdown
---
paths: **/*.lean
---

# Lean 4 Development Rules

## Tools Available
- lean_goal: Check proof state
- lean_diagnostic_messages: Compiler errors
- lean_hover_info: Type signatures
- lean_completions: IDE completions
- lean_leansearch: Natural language search
- lean_loogle: Type pattern search

## Patterns
[Domain-specific patterns...]
```

### 4.3 CLAUDE.md Imports

Use @imports for project-specific context:

```markdown
# ProofChecker

## Project Context
- @README.md - Project overview
- @.opencode/specs/TODO.md - Active tasks
- @.opencode/ARCHITECTURE.md - System architecture

## Domain Knowledge
- @.opencode/context/project/lean4/tactics.md
- @.opencode/context/project/logic/modal-semantics.md
```

---

## Phase 5: Hooks Integration (Day 8)

### 5.1 Hook Configuration

**File**: `.claude/settings.json`

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "bash .claude/hooks/validate-write.sh"
        }]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Write",
        "hooks": [{
          "type": "command",
          "command": "bash .claude/hooks/post-write-sync.sh"
        }]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "bash .claude/hooks/session-cleanup.sh"
        }]
      }
    ]
  }
}
```

### 5.2 Hook Scripts

**File**: `.claude/hooks/post-write-sync.sh`

```bash
#!/bin/bash
# Sync state.json and TODO.md after writes to specs/

FILE_PATH=$(echo "$CLAUDE_TOOL_INPUT" | jq -r '.file_path')

if [[ "$FILE_PATH" == *".opencode/specs/"* ]]; then
  # Trigger state sync validation
  python3 .claude/hooks/validate-state-sync.py
fi
```

---

## Phase 6: Testing & Validation (Days 9-10)

### 6.1 Test Cases

| Test | Command | Expected |
|------|---------|----------|
| Task creation | `/task "Test task"` | New entry in TODO.md, state.json |
| Research | `/research N` | Report created, status [RESEARCHED] |
| Plan | `/plan N` | Plan created, status [PLANNED] |
| Implement | `/implement N` | Code changes, status [COMPLETED] |
| State sync | Edit state.json | TODO.md auto-synced |
| Git commits | Any command | Appropriate commit created |
| Lean routing | Task with language=lean | Uses lean-* skills |

### 6.2 Validation Checklist

- [ ] All 9 commands work (`/task`, `/research`, `/plan`, `/implement`, `/revise`, `/review`, `/todo`, `/errors`, `/meta`)
- [ ] State management is atomic (no partial updates)
- [ ] Language routing works (lean vs general)
- [ ] Git commits are scoped and descriptive
- [ ] Skills are discovered and invoked correctly
- [ ] Hooks execute at appropriate lifecycle points
- [ ] Error handling preserves partial progress
- [ ] Resume from interruption works

---

## Migration Checklist

### Phase 1: Foundation [COMPLETED]
- [x] Create `.claude/` directory structure
- [x] Create `settings.json` with permissions and hooks
- [x] Create `CLAUDE.md` with orchestration patterns
- [x] Create initial rules files

### Phase 2: Commands [COMPLETED]
- [x] Migrate `/task` command
- [x] Migrate `/research` command
- [x] Migrate `/plan` command
- [x] Migrate `/implement` command
- [x] Migrate `/revise` command
- [x] Migrate `/review` command
- [x] Migrate `/todo` command
- [x] Migrate `/errors` command
- [x] Migrate `/meta` command

### Phase 3: Skills [COMPLETED]
- [x] Create orchestrator skill
- [x] Create researcher skill
- [x] Create planner skill
- [x] Create implementer skill
- [x] Create lean-research skill
- [x] Create lean-implementation skill
- [x] Create status-sync skill
- [x] Create git-workflow skill
- [x] Create task-management skill

### Phase 4: Context [COMPLETED]
- [x] Migrate core standards to rules/
- [x] Migrate Lean context to rules/lean4.md
- [x] Set up CLAUDE.md imports
- [x] Verify path matching works

### Phase 5: Hooks [COMPLETED]
- [x] Create hook scripts
- [x] Configure hooks in settings.json
- [x] Test hook execution

### Phase 6: Testing
- [ ] Test all commands
- [ ] Test state synchronization
- [ ] Test language routing
- [ ] Test error handling
- [ ] Test resume capability

---

## Key Differences from .opencode/

| Aspect | .opencode/ | .claude/ |
|--------|-----------|----------|
| Orchestration | Explicit orchestrator.md agent | CLAUDE.md + automatic skill discovery |
| Commands | Full agents with XML workflow | Simpler markdown with instructions |
| Subagents | Explicit delegation with session IDs | Skills with `context: fork` isolation |
| State management | Custom two-phase commit | Hooks + skills for atomic updates |
| Context loading | Explicit tier system | @imports + path-matched rules |
| Error handling | errors.json + /errors command | Same (unchanged) |
| Git integration | git-workflow-manager agent | Hook-triggered or in-command |

---

## Estimated Timeline

| Phase | Duration | Effort |
|-------|----------|--------|
| Phase 1: Foundation | 1 day | Setup and configuration |
| Phase 2: Commands | 2 days | 9 command files |
| Phase 3: Skills | 3 days | 9 skill directories |
| Phase 4: Context | 1 day | Rules and imports |
| Phase 5: Hooks | 1 day | Hook scripts and config |
| Phase 6: Testing | 2 days | Validation and fixes |
| **Total** | **10 days** | Full migration |

---

## Rollback Strategy

If migration fails:
1. Keep `.opencode/` intact during migration
2. Test `.claude/` in parallel
3. Only deprecate `.opencode/` after full validation
4. Git branch strategy: `feature/claude-migration`

---

## Success Criteria

1. All 9 commands produce equivalent output
2. State management is atomic and consistent
3. Language-based routing works correctly
4. Git commits follow same conventions
5. Error handling preserves progress
6. Resume from interruption works
7. User workflow UX is equivalent or better
