# CI/CD Pipeline for ProofChecker
# Runs on push and pull requests

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Get Lean version
      run: |
        cat lean-toolchain
        lean --version

    - name: Cache Lake packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.elan
          .lake
        key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.toml', 'lean-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-lake-

    - name: Build project
      run: lake build

    - name: Run tests
      run: lake test
      continue-on-error: true  # Remove when tests are implemented

    - name: Run linter
      run: lake lint
      continue-on-error: true  # Remove when lint is configured

  docs:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install elan
      run: |
        curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
        echo "$HOME/.elan/bin" >> $GITHUB_PATH

    - name: Cache Lake packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.elan
          .lake
        key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.toml', 'lean-toolchain') }}
        restore-keys: |
          ${{ runner.os }}-lake-

    - name: Generate documentation
      run: lake build :docs
      continue-on-error: true  # Remove when docs target is configured

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./doc
        destination_dir: api
      continue-on-error: true  # Remove when docs are generated
