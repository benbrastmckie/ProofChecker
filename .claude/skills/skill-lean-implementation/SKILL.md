---
name: skill-lean-implementation
description: Implement Lean 4 proofs and definitions using lean-lsp tools. Invoke for Lean-language implementation tasks.
allowed-tools: Task
---

# Lean Implementation Skill

Thin wrapper that delegates Lean proof implementation to `lean-implementation-agent` subagent.

**Note**: This skill does NOT handle checkpoints (preflight/postflight).
The calling command handles all state management operations.

## Trigger Conditions

This skill activates when:
- Task language is "lean"
- /implement command targets a Lean task
- Proofs or definitions need to be written

---

## Inputs

- `task_number` - Task to implement (required)
- `session_id` - Session tracking ID (from command)
- `task_dir` - Task directory path for artifacts
- `plan_path` - Path to implementation plan
- `resume_phase` - Phase number to resume from (default: 1)

---

## Execution

### 1. Input Validation

Validate required inputs from command:

```bash
# All inputs come from the calling command
# - task_number: verified by command
# - session_id: generated by command
# - task_dir: created by command
# - plan_path: found by command
# - resume_phase: determined by command

if [ -z "$task_number" ]; then
  return error "task_number is required"
fi
if [ -z "$session_id" ]; then
  return error "session_id is required"
fi
if [ -z "$plan_path" ]; then
  return error "plan_path is required"
fi
```

### 2. Prepare Delegation Context

Prepare delegation context for the subagent:

```json
{
  "session_id": "{session_id from command}",
  "delegation_depth": 1,
  "delegation_path": ["orchestrator", "implement", "skill-lean-implementation"],
  "timeout": 7200,
  "task_context": {
    "task_number": N,
    "task_name": "{project_name}",
    "description": "{description}",
    "language": "lean"
  },
  "plan_path": "{path to implementation plan}",
  "resume_phase": N,
  "metadata_file_path": "{task_dir}/.meta/implement-return-meta.json"
}
```

### 3. Invoke Subagent

**CRITICAL**: You MUST use the **Task** tool to spawn the subagent.

**Required Tool Invocation**:
```
Tool: Task (NOT Skill)
Parameters:
  - subagent_type: "lean-implementation-agent"
  - prompt: [Include task_context, delegation_context, plan_path, resume_phase, metadata_file_path]
  - description: "Execute Lean implementation for task {N}"
```

**DO NOT** use `Skill(lean-implementation-agent)` - this will FAIL.

The subagent will:
- Load Lean-specific context files
- Use MCP tools (lean_goal, lean_diagnostic_messages, etc.)
- Execute proof development loop
- Create/modify .lean files
- Run lake build to verify
- Create implementation summary
- Write metadata to `{task_dir}/.meta/implement-return-meta.json`
- Return a brief text summary (NOT JSON)

### 4. Return Brief Summary

Return the subagent's text summary to the calling command.
The command handles metadata reading and postflight operations.

---

## Return Format

This skill returns the **subagent's brief text summary** directly to the calling command.

The command then:
1. Reads the metadata file at `{task_dir}/.meta/implement-return-meta.json`
2. Updates state.json status to "completed" (or keeps "implementing" if partial)
3. Updates TODO.md status to [COMPLETED] (or keeps [IMPLEMENTING] if partial)
4. Populates completion_summary and roadmap_items
5. Links summary artifact
6. Creates git commit

---

## Error Handling

### Input Validation Errors
Return immediately with error message if required inputs missing.

### Subagent Errors
Return the subagent's error text to the calling command.
Command decides how to handle (keep status, log error).

### Timeout
Return partial status text if subagent times out.
Command handles status preservation.
