---
name: skill-lean-research
description: Research Lean 4 and Mathlib for theorem proving tasks. Invoke for Lean-language research using LeanSearch, Loogle, and lean-lsp tools.
allowed-tools: Task
---

# Lean Research Skill

Thin wrapper that delegates Lean 4 research to `lean-research-agent` subagent.

**Note**: This skill does NOT handle checkpoints (preflight/postflight).
The calling command handles all state management operations.

## Trigger Conditions

This skill activates when:
- Task language is "lean"
- Research involves Mathlib, theorems, or proofs
- Lean-specific MCP tools are needed

---

## Inputs

- `task_number` - Task to research (required)
- `session_id` - Session tracking ID (from command)
- `focus_prompt` - Optional focus for research direction
- `task_dir` - Task directory path for artifacts

---

## Execution

### 1. Input Validation

Validate required inputs from command:

```bash
# All inputs come from the calling command
# - task_number: verified by command
# - session_id: generated by command
# - task_dir: created by command
# - focus_prompt: optional

if [ -z "$task_number" ]; then
  return error "task_number is required"
fi
if [ -z "$session_id" ]; then
  return error "session_id is required"
fi
```

### 2. Prepare Delegation Context

Prepare delegation context for the subagent:

```json
{
  "session_id": "{session_id from command}",
  "delegation_depth": 1,
  "delegation_path": ["orchestrator", "research", "skill-lean-research"],
  "timeout": 3600,
  "task_context": {
    "task_number": N,
    "task_name": "{project_name}",
    "description": "{description}",
    "language": "lean"
  },
  "focus_prompt": "{optional focus}",
  "metadata_file_path": "{task_dir}/.meta/research-return-meta.json"
}
```

### 3. Invoke Subagent

**CRITICAL**: You MUST use the **Task** tool to spawn the subagent.

**Required Tool Invocation**:
```
Tool: Task (NOT Skill)
Parameters:
  - subagent_type: "lean-research-agent"
  - prompt: [Include task_context, delegation_context, focus_prompt, metadata_file_path]
  - description: "Execute Lean research for task {N}"
```

**DO NOT** use `Skill(lean-research-agent)` - this will FAIL.

The subagent will:
- Load Lean-specific context files
- Use MCP search tools (leansearch, loogle, leanfinder)
- Create research report in `{task_dir}/reports/`
- Write metadata to `{task_dir}/.meta/research-return-meta.json`
- Return a brief text summary (NOT JSON)

### 4. Return Brief Summary

Return the subagent's text summary to the calling command.
The command handles metadata reading and postflight operations.

---

## Return Format

This skill returns the **subagent's brief text summary** directly to the calling command.

The command then:
1. Reads the metadata file at `{task_dir}/.meta/research-return-meta.json`
2. Updates state.json status to "researched"
3. Updates TODO.md status to [RESEARCHED]
4. Links artifacts
5. Creates git commit

---

## Error Handling

### Input Validation Errors
Return immediately with error message if required inputs missing.

### Subagent Errors
Return the subagent's error text to the calling command.
Command decides how to handle (keep status, log error).

### Timeout
Return partial status text if subagent times out.
Command handles status preservation.
