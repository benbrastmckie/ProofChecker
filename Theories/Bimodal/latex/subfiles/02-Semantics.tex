\documentclass[../BimodalReference.tex]{subfiles}
\begin{document}

\section{Task Semantics}

\subsection{Task Frames}

Task frames are the fundamental semantic structures for \textbf{TM}.

% TODO: Replace 'R(w, x, u)' with 'w \Rightarrow_x u'

\begin{definition}[Task Frame]
A \textbf{task frame} over temporal type $T$ (with totally ordered abelian group structure)
is a triple $\taskframe = (\worldstate, T, R)$ where:
\begin{itemize}
  \item $\worldstate$ is a type of world states
  \item $T$ is the temporal duration type with \leansrc{LinearOrderedAddCommGroup} instance
  \item $R : \worldstate \times T \times \worldstate \to \text{Prop}$ is the task relation
\end{itemize}
satisfying two constraints:
\begin{enumerate}
  \item \textbf{Nullity}: $\forall w.\, R(w, 0, w)$
  \item \textbf{Compositionality}: $\forall w\, u\, v\, x\, y.\, R(w, x, u) \land R(u, y, v) \to R(w, x+y, v)$
\end{enumerate}
\end{definition}

The nullity constraint ensures zero-duration tasks are identity.
Compositionality ensures sequential tasks compose with additive time.

\begin{center}
\begin{tabular}{@{}lll@{}}
\toprule
Lean Field & Type & Description \\
\midrule
\texttt{WorldState} & \texttt{Type} & World state type \\
\texttt{task\_rel} & \texttt{WorldState $\to$ T $\to$ WorldState $\to$ Prop} & Task relation \\
\texttt{nullity} & \texttt{$\forall$ w, task\_rel w 0 w} & Identity constraint \\
\texttt{compositionality} & (see below) & Composition constraint \\
\bottomrule
\end{tabular}
\end{center}

\subsection{World Histories}

A world history is a temporal slice through a task frame.

\begin{definition}[World History]
A \textbf{world history} in task frame $\taskframe$ is a structure $\history$ with:
\begin{itemize}
  \item $\domain : T \to \text{Prop}$ --- a convex temporal domain
  \item $\text{states} : (t : T) \to \domain(t) \to \worldstate$ --- world state at each time
  \item $\text{respects\_task}$ --- states respect the task relation
\end{itemize}
\end{definition}

\begin{definition}[Convex Domain]
A domain $\domain : T \to \text{Prop}$ is \textbf{convex} if:
\[
\forall a\, b\, c.\, \domain(a) \land \domain(c) \land a \le b \land b \le c \to \domain(b)
\]
\end{definition}

\begin{definition}[Respects Task]
A history respects the task relation if for all $s, t$ in the domain:
\[
R(\text{states}(s), t - s, \text{states}(t))
\]
\end{definition}

\begin{center}
\begin{tabular}{@{}lll@{}}
\toprule
Lean Field & Type & Description \\
\midrule
\texttt{domain} & \texttt{T $\to$ Prop} & Temporal domain \\
\texttt{convex} & \texttt{Convex domain} & Domain convexity \\
\texttt{states} & \texttt{(t : T) $\to$ domain t $\to$ WorldState} & State function \\
\texttt{respects\_task} & (see code) & Task relation respect \\
\bottomrule
\end{tabular}
\end{center}

\subsection{Task Models}

A task model adds valuation to a task frame.

\begin{definition}[Task Model]
A \textbf{task model} over frame $\taskframe$ is a structure $\model$ with valuation:
\[
V : \worldstate \to \text{String} \to \text{Prop}
\]
where $V(w, p)$ holds iff atomic proposition $p$ is true at world state $w$.
\end{definition}

\subsection{Truth Conditions}

Truth is defined relative to a model, history, and time.

\begin{definition}[Truth at a Point]
For model $\model$, history $\history$, time $t \in \domain(\history)$:
\begin{align*}
  \truthat{\model}{\history}{t}{p} &\iff V(\text{states}(t), p) \\
  \truthat{\model}{\history}{t}{\falsum} &\iff \text{False} \\
  \truthat{\model}{\history}{t}{\varphi \imp \psi} &\iff
    \truthat{\model}{\history}{t}{\varphi} \to \truthat{\model}{\history}{t}{\psi} \\
  \truthat{\model}{\history}{t}{\nec\varphi} &\iff
    \forall \history'.\, \text{states}'(t) = \text{states}(t) \to
      \truthat{\model}{\history'}{t}{\varphi} \\
  \truthat{\model}{\history}{t}{\allpast\varphi} &\iff
    \forall s \le t.\, s \in \domain \to \truthat{\model}{\history}{s}{\varphi} \\
  \truthat{\model}{\history}{t}{\allfuture\varphi} &\iff
    \forall s \ge t.\, s \in \domain \to \truthat{\model}{\history}{s}{\varphi}
\end{align*}
\end{definition}

The modal operator $\nec$ quantifies over all histories agreeing at the current world state.
The temporal operators $\allpast$ and $\allfuture$ quantify over past and future times within the history's domain.

\subsection{Time-Shift}

The time-shift operation translates a history by a temporal offset.

\begin{definition}[Time-Shift]
Given history $\history$ and offset $d : T$:
\[
\text{time\_shift}(\history, d) = \history'
\]
where:
\begin{itemize}
  \item $\domain'(t) \iff \domain(t + d)$
  \item $\text{states}'(t) = \text{states}(t + d)$
\end{itemize}
\end{definition}

\begin{theorem}[Time-Shift Preserves Convexity]
If $\history$ has convex domain, so does $\text{time\_shift}(\history, d)$.
\end{theorem}

\begin{theorem}[Time-Shift Preserves Task Respect]
If $\history$ respects the task relation, so does $\text{time\_shift}(\history, d)$.
\end{theorem}

The time-shift construction is essential for proving the temporal axioms MF and TF.

\subsection{Validity}

\begin{definition}[Validity]
A formula $\varphi$ is \textbf{valid} (written $\valid{\varphi}$) if:
\[
\forall T.\, \forall \taskframe : \text{TaskFrame}\, T.\, \forall \model.\,
\forall \history.\, \forall t \in \domain.\,
\truthat{\model}{\history}{t}{\varphi}
\]
where $T$ ranges over all types with \leansrc{LinearOrderedAddCommGroup} instance.
\end{definition}

\begin{definition}[Semantic Consequence]
$\context \satisfies \varphi$ (semantic consequence) holds if in every model
where all formulas in $\context$ are true, $\varphi$ is also true.
\end{definition}

\begin{definition}[Satisfiability]
A context $\context$ is \textbf{satisfiable} in temporal type $T$ if there exists
a model $\model$, history $\history$, and time $t$ where all formulas in $\context$ are true.
\end{definition}

\begin{theorem}[Valid iff Empty Consequence]
$\valid{\varphi} \iff [] \satisfies \varphi$
\end{theorem}

\begin{theorem}[Monotonicity]
If $\context \subseteq \Delta$ and $\context \satisfies \varphi$, then $\Delta \satisfies \varphi$.
\end{theorem}

\end{document}
